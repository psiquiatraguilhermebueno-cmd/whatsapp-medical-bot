<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin • Pacientes</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; }
    h1 { margin: 0 0 16px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; }
    .row { display: flex; gap: 8px; align-items: center; margin: 8px 0; }
    input, button { padding: 10px 12px; border-radius: 6px; border: 1px solid #ccc; }
    button { cursor: pointer; }
    .msg { margin-top: 8px; font-size: 14px; }
    .ok { color: #0a7; }
    .err { color: #c00; }
    ul { list-style: none; padding: 0; margin: 8px 0 0; }
    li { padding: 8px 0; border-bottom: 1px dashed #eee; display: flex; justify-content: space-between; gap: 8px; flex-wrap: wrap; }
    .pill { font-size: 12px; background: #f3f3f3; padding: 2px 6px; border-radius: 4px; }
    .actions { display: flex; gap: 6px; }
    .ghost { background: #fff; }
  </style>
</head>
<body>
  <h1>Admin • Pacientes</h1>

  <div class="grid">
    <div class="card">
      <h3>Novo paciente</h3>
      <form id="newPatientForm">
        <div class="row"><input id="name" placeholder="Nome completo" required /></div>
        <div class="row"><input id="phone" placeholder="Telefone (ex: +5511999999999)" required /></div>
        <div class="row"><input id="tags" placeholder="Tags (ex: spa, uetg)" /></div>
        <div class="row"><button id="createBtn" type="submit">Criar</button></div>
        <div id="createMsg" class="msg"></div>
      </form>
    </div>

    <div class="card">
      <h3>Buscar pacientes</h3>
      <form id="searchForm" class="row">
        <input id="q" placeholder="Nome, tags ou dígitos do telefone" />
        <button type="submit">Buscar</button>
      </form>
      <ul id="searchResults"></ul>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3>Recentes</h3>
    <ul id="recentList"></ul>
  </div>

  <script>
    function $(sel){ return document.querySelector(sel); }
    async function api(url, options={}){
      const res = await fetch(url, Object.assign({ headers: { 'Accept': 'application/json' }}, options));
      const text = await res.text();
      try { return JSON.parse(text); } catch { return { ok:false, error:'non_json_response', raw:text, status: res.status }; }
    }
    async function apiJSON(url, method, body){
      return api(url, { method, headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body: JSON.stringify(body || {}) });
    }
    function cleanDigits(s){ return (s || '').replace(/\D+/g,''); }
    function normPhone(s){
      const d = cleanDigits(s);
      if(!d) return '';
      if(d.startsWith('55')) return '+' + d;
      return '+55' + d;
    }
    function renderItem(p){
      const span = document.createElement('span');
      span.textContent = `${p.name} — ${p.phone_e164} ${p.tags ? '('+p.tags+')' : ''}`;
      const actions = document.createElement('span');
      actions.className = 'actions';
      const bEdit = document.createElement('button');
      bEdit.className = 'ghost';
      bEdit.textContent = 'Editar';
      bEdit.onclick = async () => editPatient(p);
      const bDel = document.createElement('button');
      bDel.className = 'ghost';
      bDel.textContent = 'Excluir';
      bDel.onclick = async () => deletePatient(p);
      actions.appendChild(bEdit);
      actions.appendChild(bDel);
      const li = document.createElement('li');
      li.appendChild(span);
      li.appendChild(actions);
      return li;
    }
    async function loadRecent(){
      const ul = $('#recentList');
      ul.innerHTML = '<li>Carregando…</li>';
      const data = await api('/admin/api/patients?limit=10');
      ul.innerHTML = '';
      if(!data || !data.items || data.items.length===0){
        ul.innerHTML = '<li>Nenhum paciente.</li>';
        return;
      }
      data.items.forEach(p => ul.appendChild(renderItem(p)));
    }
    async function createPatient(ev){
      ev && ev.preventDefault && ev.preventDefault();
      const btn = $('#createBtn');
      const msg = $('#createMsg');
      msg.className = 'msg';
      msg.textContent = '';
      btn.disabled = true;
      const payload = {
        name: $('#name').value.trim(),
        phone_e164: normPhone($('#phone').value),
        tags: $('#tags').value.trim()
      };
      const res = await apiJSON('/admin/api/patients','POST',payload);
      if(res && res.ok){
        msg.className = 'msg ok';
        msg.textContent = res.created === false ? 'Já existia. OK!' : 'Criado com sucesso.';
        $('#newPatientForm').reset();
        loadRecent();
      } else {
        msg.className = 'msg err';
        msg.textContent = (res && (res.detail || res.error)) ? ('Erro: ' + (res.detail || res.error)) : 'Erro ao criar.';
      }
      btn.disabled = false;
    }
    async function searchPatients(ev){
      ev && ev.preventDefault && ev.preventDefault();
      const q = $('#q').value.trim();
      const ul = $('#searchResults');
      ul.innerHTML = '';
      if(!q) return;
      const data = await api('/admin/api/patients/search?q=' + encodeURIComponent(q));
      if(!data || !data.items) return;
      if(data.items.length===0){ ul.innerHTML = '<li>Nenhum resultado.</li>'; return; }
      data.items.forEach(p => ul.appendChild(renderItem(p)));
    }
    async function editPatient(p){
      const name = prompt('Nome:', p.name || '') ?? p.name;
      const phone = prompt('Telefone (+55…):', p.phone_e164 || '') ?? p.phone_e164;
      const tags = prompt('Tags:', p.tags || '') ?? p.tags;
      const payload = { name: name.trim(), phone_e164: normPhone(phone), tags: (tags||'').trim() };
      const res = await apiJSON('/admin/api/patients/'+p.id,'PATCH',payload);
      if(res && res.ok){ loadRecent(); searchPatients(); }
      else { alert('Falhou ao editar'); }
    }
    async function deletePatient(p){
      if(!confirm(`Excluir ${p.name}?`)) return;
      const res = await api('/admin/api/patients/'+p.id, { method: 'DELETE' });
      if(res && res.ok){ loadRecent(); searchPatients(); }
      else { alert('Falhou ao excluir'); }
    }
    document.addEventListener('DOMContentLoaded', () => {
      $('#newPatientForm').addEventListener('submit', createPatient);
      $('#searchForm').addEventListener('submit', searchPatients);
      loadRecent();
    });
  </script>
</body>
</html>
